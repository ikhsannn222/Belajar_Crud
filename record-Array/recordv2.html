<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>CRUD Mahasiswa - Edit</title>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }
      th,
      td {
        border: 1px solid #444;
        padding: 6px;
        text-align: left;
      }
      input[type="text"],
      input[type="date"],
      input[type="number"] {
        width: 100%;
        box-sizing: border-box;
      }
      button {
        margin-right: 4px;
      }
      .form-group {
        margin-bottom: 12px;
      }

      .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 4px;
      }

      .form-group input {
        padding: 6px;
        border: 1px solid #444;
        border-radius: 4px;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <h3>Data Mahasiswa</h3>

    <div class="form-group">
      <label for="nama">Nama</label>
      <input type="text" id="nama" />
    </div>

    <hr>

    <div class="form-group">
      <label for="tglLahir">Tanggal Lahir</label>
      <input type="date" id="tglLahir" />
    </div>

    <div class="form-group">
      <label for="ipk">IPK</label>
      <input type="number" step="0.01" id="ipk" />
    </div>

    <button onclick="tambah()">Tambah</button>

    <hr />
    <hr>
    <hr>
    <hr>
    <hr>
    <hr>

    <div id="hasil"></div>
    <div id="info"></div>

    <script>
      let data = [];

      function hitungUmur(tgl) {
        if (!tgl) return 0;
        const lahir = new Date(tgl);
        const today = new Date();
        let umur = today.getFullYear() - lahir.getFullYear();
        const m = today.getMonth() - lahir.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < lahir.getDate())) umur--;
        return umur;
      }

      function tambah() {
        const nama = document.getElementById("nama").value.trim();
        const tglLahir = document.getElementById("tglLahir").value;
        const ipk = parseFloat(document.getElementById("ipk").value);

        if (nama === "" || tglLahir === "" || isNaN(ipk)) {
          Swal.fire({
            icon: "warning",
            title: "Data tidak lengkap",
            text: "Semua field harus diisi dengan benar!",
          });
          return;
        }

        if (ipk > 4) {
          Swal.fire({
            icon: "error",
            title: "IPK tidak valid",
            text: "IPK tidak boleh lebih dari 4.00",
          });
          return;
        }

        const umur = hitungUmur(tglLahir);
        data.push({ nama, tglLahir, umur, ipk, isEditing: false });

        Swal.fire({
          icon: "success",
          title: "Berhasil!",
          text: "Data berhasil ditambahkan",
          timer: 1200,
          showConfirmButton: false,
        });

        resetForm();
        tampil();
      }

      function resetForm() {
        document.getElementById("nama").value = "";
        document.getElementById("tglLahir").value = "";
        document.getElementById("ipk").value = "";
      }

      function tampil() {
        let html1 = "<h3>Tabel 1 - Data Asli</h3>";
        html1 +=
          "<table><tr><th>No</th><th>Nama</th><th>Tgl Lahir</th><th>Umur</th><th>IPK</th><th>Aksi</th></tr>";

        data.forEach((m, i) => {
          if (m.isEditing) {
            html1 += `<tr>
        <td>${i + 1}</td>
        <td><input type="text" id="edit-nama-${i}" value="${escapeHtml(
              m.nama
            )}"></td>
        <td><input type="date" id="edit-tgl-${i}" value="${m.tglLahir}"></td>
        <td>${m.umur}</td>
        <td><input type="number" step="0.01" id="edit-ipk-${i}" value="${
              m.ipk
            }"></td>
        <td>
          <button onclick="simpan(${i})">Simpan</button>
          <button onclick="batalEdit(${i})">Batal</button>
          <button onclick="hapusByNama('${m.nama.replace(
            /'/g,
            "\\'"
          )}')">Hapus</button>
        </td>
      </tr>`;
          } else {
            html1 += `<tr>
        <td>${i + 1}</td>
        <td>${escapeHtml(m.nama)}</td>
        <td>${m.tglLahir}</td>
        <td>${m.umur}</td>
        <td>${m.ipk}</td>
        <td>
          <button onclick="mulaiEdit(${i})">Edit</button>
          <button onclick="hapusByNama('${m.nama.replace(
            /'/g,
            "\\'"
          )}')">Hapus</button>
        </td>
      </tr>`;
          }
        });

        if (data.length === 0) {
          html1 += `<tr><td colspan="6"><center>Tidak ada data.</center></td></tr>`;
        }

        html1 += "</table>";

        const dataNama = [...data].sort((a, b) => a.nama.localeCompare(b.nama));
        let html2 = "<h3>Tabel 2 - Berdasarkan Nama (A - Z)</h3>";
        html2 +=
          "<table><tr><th>No</th><th>Nama</th><th>Tgl Lahir</th><th>Umur</th><th>IPK</th></tr>";
        dataNama.forEach((m, i) => {
          html2 += `<tr>
      <td>${i + 1}</td>
      <td>${escapeHtml(m.nama)}</td>
      <td>${m.tglLahir}</td>
      <td>${m.umur}</td>
      <td>${m.ipk}</td>
    </tr>`;
        });
        if (dataNama.length === 0)
          html2 += `<tr><td colspan="5"><center>Tidak ada data.</center></td></tr>`;
        html2 += "</table>";

        const dataUmur = data.filter((m) => m.umur > 20);
        let html3 = "<h3>Tabel 3 - Umur &gt; 20 Tahun</h3>";
        html3 +=
          "<table><tr><th>No</th><th>Nama</th><th>Tgl Lahir</th><th>Umur</th><th>IPK</th></tr>";
        dataUmur.forEach((m, i) => {
          html3 += `<tr>
      <td>${i + 1}</td>
      <td>${escapeHtml(m.nama)}</td>
      <td>${m.tglLahir}</td>
      <td>${m.umur}</td>
      <td>${m.ipk}</td>
    </tr>`;
        });
        if (dataUmur.length === 0)
          html3 += `<tr><td colspan="5"><center>Tidak ada mahasiswa umur di atas 20 tahun.</center></td></tr>`;
        html3 += "</table>";

        let ipkDesc = [...data].sort((a, b) => b.ipk - a.ipk);
        let html4 = "<h3>Tabel 4 - Ranking IPK (Tertinggi → Terendah)</h3>";
        html4 += "<table><tr><th>No</th><th>Nama</th><th>IPK</th></tr>";

        ipkDesc.forEach((m, i) => {
          html4 += `<tr>
      <td>${i + 1}</td>
      <td>${escapeHtml(m.nama)}</td>
      <td>${m.ipk}</td>
    </tr>`;
        });
        if (ipkDesc.length === 0)
          html4 += `<tr><td colspan="3"><center>Tidak ada data.</center></td></tr>`;
        html4 += "</table>";

        let ipkAsc = [...data].sort((a, b) => a.ipk - b.ipk);
        let html5 = "<h3>Tabel 5 - Ranking IPK (Terendah → Tertinggi)</h3>";
        html5 += "<table><tr><th>No</th><th>Nama</th><th>IPK</th></tr>";

        ipkAsc.forEach((m, i) => {
          html5 += `<tr>
      <td>${i + 1}</td>
      <td>${escapeHtml(m.nama)}</td>
      <td>${m.ipk}</td>
    </tr>`;
        });
        if (ipkAsc.length === 0)
          html5 += `<tr><td colspan='3'><center>Tidak ada data.</center></td></tr>`;
        html5 += "</table>";

        document.getElementById("hasil").innerHTML =
          html1 +
          "<br>" +
          html2 +
          "<br>" +
          html3 +
          "<br>" +
          html4 +
          "<br>" +
          html5;

        tampilInfo();
      }

      function escapeHtml(text) {
        if (typeof text !== "string") return text;
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function mulaiEdit(index) {
        data.forEach((d) => (d.isEditing = false));
        data[index].isEditing = true;

        Swal.fire({
          icon: "info",
          title: "Mode Edit",
          text: "Silakan ubah data pada baris tersebut.",
          timer: 1200,
          showConfirmButton: false,
        });

        tampil();
      }

      function batalEdit(index) {
        data[index].isEditing = false;
        tampil();
      }

      function simpan(index) {
        const namaEl = document.getElementById(`edit-nama-${index}`);
        const tglEl = document.getElementById(`edit-tgl-${index}`);
        const ipkEl = document.getElementById(`edit-ipk-${index}`);

        const namaBaru = namaEl.value.trim();
        const tglBaru = tglEl.value;
        const ipkBaru = parseFloat(ipkEl.value);

        if (namaBaru === "" || tglBaru === "" || isNaN(ipkBaru)) {
          Swal.fire({
            icon: "warning",
            title: "Data tidak lengkap",
            text: "Isi semua field dengan benar!",
          });
          return;
        }

        if (ipkBaru > 4) {
          Swal.fire({
            icon: "error",
            title: "IPK tidak valid",
            text: "IPK tidak boleh lebih dari 4.00",
          });
          return;
        }

        data[index].nama = namaBaru;
        data[index].tglLahir = tglBaru;
        data[index].ipk = ipkBaru;
        data[index].umur = hitungUmur(tglBaru);
        data[index].isEditing = false;

        Swal.fire({
          icon: "success",
          title: "Tersimpan!",
          text: "Data berhasil diperbarui.",
          timer: 1000,
          showConfirmButton: false,
        });

        tampil();
      }

      function hapusByNama(nama) {
        Swal.fire({
          title: `Hapus semua data dengan nama "${nama}"?`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Hapus",
          cancelButtonText: "Batal",
        }).then((res) => {
          if (res.isConfirmed) {
            data = data.filter((m) => m.nama !== nama);

            Swal.fire({
              icon: "success",
              title: "Terhapus!",
              text: "Data berhasil dihapus.",
              timer: 1200,
              showConfirmButton: false,
            });

            tampil();
          }
        });
      }

      function tampilInfo() {
        const jumlah = data.length;
        const totalIpk = data.reduce(
          (s, m) => s + (isNaN(m.ipk) ? 0 : m.ipk),
          0
        );
        const rata = jumlah ? (totalIpk / jumlah).toFixed(2) : "0.00";

        let nilaiSorted = data.map((m) => m.ipk).sort((a, b) => a - b);

        let median = "-";

        if (nilaiSorted.length > 0) {
          let avg = nilaiSorted.reduce((a, b) => a + b, 0) / nilaiSorted.length;

          let nearest = nilaiSorted[0];
          let selisihMin = Math.abs(nilaiSorted[0] - avg);

          for (let i = 1; i < nilaiSorted.length; i++) {
            let selisih = Math.abs(nilaiSorted[i] - avg);

            if (
              selisih < selisihMin ||
              (selisih === selisihMin && nilaiSorted[i] > nearest)
            ) {
              nearest = nilaiSorted[i];
              selisihMin = selisih;
            }
          }

          median = nearest;
        }

        const diAtas20 =
          data
            .filter((m) => m.umur > 20)
            .map((m) => m.nama)
            .join(", ") || "-";
        const urutIpk =
          [...data]
            .sort((a, b) => b.ipk - a.ipk)
            .map((m) => `${m.nama} (${m.ipk})`)
            .join(", ") || "-";

        const info = `
    <p><b>Jumlah Data:</b> ${jumlah}</p>
    <p><b>Rata-rata IPK:</b> ${rata}</p>
    <p><b>Nilai Tengah (Median Versi Project):</b> ${median}</p>
    <p><b>Mahasiswa Umur > 20:</b> ${diAtas20}</p>`;

        document.getElementById("info").innerHTML = info;
      }
    </script>
  </body>
</html>
